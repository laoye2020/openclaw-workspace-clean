# ğŸ“¦ é’‰é’‰å‡ºå…¥åº“è‡ªåŠ¨åŒ–æ–¹æ¡ˆ

> è‡ªåŠ¨è¯†åˆ«å‡ºå…¥åº“ä¿¡æ¯å¹¶å½•å…¥é’‰é’‰è¡¨æ ¼

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·å‘é€   â”‚â”€â”€â”€â”€â–¶â”‚  é’‰é’‰æœºå™¨äºº  â”‚â”€â”€â”€â”€â–¶â”‚  ä¿¡æ¯è§£æ   â”‚
â”‚ å‡ºå…¥åº“ä¿¡æ¯   â”‚     â”‚  (OpenClaw) â”‚     â”‚  (AI/è§„åˆ™)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  é’‰é’‰è¡¨æ ¼API  â”‚
              â”‚  è‡ªåŠ¨å½•å…¥æ•°æ®  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### 1ï¸âƒ£ é’‰é’‰åå°é…ç½®ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰

**åˆ›å»ºä¼ä¸šå†…éƒ¨åº”ç”¨ï¼š**
1. ç™»å½• [é’‰é’‰å¼€æ”¾å¹³å°](https://open.dingtalk.com/)
2. åˆ›å»ºåº”ç”¨ â†’ ä¼ä¸šå†…éƒ¨åº”ç”¨
3. è®°å½•ï¼š`AppKey` å’Œ `AppSecret`

**ç”³è¯·æƒé™ï¼š**
- `dingtalk.oapi.ding.doc.write` (æ–‡æ¡£å†™å…¥)
- `dingtalk.oapi.ding.doc.read` (æ–‡æ¡£è¯»å–)
- `dingtalk.oapi.user.get` (è·å–ç”¨æˆ·ä¿¡æ¯)

**åˆ›å»ºè¡¨æ ¼ï¼š**
1. åœ¨é’‰é’‰æ–‡æ¡£åˆ›å»ºè¡¨æ ¼
2. è®¾ç½®åˆ—ï¼šæ—¥æœŸ | å•å· | ç±»å‹(å…¥åº“/å‡ºåº“) | ç‰©æ–™ | æ•°é‡ | ç»åŠäºº | å¤‡æ³¨
3. åˆ†äº«è¡¨æ ¼ç»™æœºå™¨äººåº”ç”¨ï¼ˆç¼–è¾‘æƒé™ï¼‰

---

### 2ï¸âƒ£ OpenClaw é…ç½®

**å®‰è£…é’‰é’‰æ’ä»¶ï¼š**
```bash
openclaw plugins install https://github.com/soimy/openclaw-channel-dingtalk.git
```

**é…ç½®æ–‡ä»¶ï¼š**
```json
{
  "channels": {
    "dingtalk": {
      "enabled": true,
      "clientId": "ä½ çš„AppKey",
      "clientSecret": "ä½ çš„AppSecret",
      "robotCode": "ä½ çš„æœºå™¨äººç¼–ç ",
      "dmPolicy": "open"
    }
  }
}
```

**çƒ­é‡è½½ï¼š**
```bash
pkill -SIGUSR1 -f "openclaw gateway"
```

---

### 3ï¸âƒ£ åˆ›å»ºå‡ºå…¥åº“æŠ€èƒ½

åˆ›å»ºæ–‡ä»¶ï¼š`skills/inventory/skill.py`

```python
#!/usr/bin/env python3
"""
å‡ºå…¥åº“ç®¡ç†æŠ€èƒ½
è‡ªåŠ¨è§£ææ¶ˆæ¯å¹¶å½•å…¥é’‰é’‰è¡¨æ ¼
"""

import re
import json
import urllib.request
from datetime import datetime

class InventoryManager:
    def __init__(self, app_key, app_secret, sheet_id):
        self.app_key = app_key
        self.app_secret = app_secret
        self.sheet_id = sheet_id
        self.access_token = self._get_access_token()
    
    def _get_access_token(self):
        """è·å–é’‰é’‰è®¿é—®ä»¤ç‰Œ"""
        url = f"https://oapi.dingtalk.com/gettoken?appkey={self.app_key}&appsecret={self.app_secret}"
        with urllib.request.urlopen(url) as res:
            data = json.loads(res.read())
            return data['access_token']
    
    def parse_inventory_message(self, text):
        """
        è§£æå‡ºå…¥åº“ä¿¡æ¯
        æ”¯æŒæ ¼å¼ï¼š
        - å…¥åº“ï¼šå…¥åº“ 100ä»¶  iPhone15  å•å·RK20240207  å¼ ä¸‰
        - å‡ºåº“ï¼šå‡ºåº“ 50å°  åä¸ºMate60  å•å·CK20240207  æå››  å®¢æˆ·ï¼šç‹äº”
        """
        # æ­£åˆ™åŒ¹é…
        pattern = r'(å…¥åº“|å‡ºåº“)\s+(\d+)(ä»¶|å°|ä¸ª|ç®±|kg)?\s+(.+?)\s+å•å·([A-Z0-9]+)\s+ç»åŠäºº?[:\s]*(\w+)'
        match = re.search(pattern, text)
        
        if match:
            return {
                'type': match.group(1),  # å…¥åº“/å‡ºåº“
                'quantity': match.group(2),  # æ•°é‡
                'unit': match.group(3) or 'ä»¶',  # å•ä½
                'item': match.group(4).strip(),  # ç‰©æ–™åç§°
                'order_no': match.group(5),  # å•å·
                'operator': match.group(6),  # ç»åŠäºº
                'date': datetime.now().strftime('%Y-%m-%d %H:%M'),
                'remark': ''
            }
        return None
    
    def add_to_sheet(self, data):
        """æ·»åŠ åˆ°é’‰é’‰è¡¨æ ¼"""
        url = "https://oapi.dingtalk.com/documents/sheets/values/append"
        
        payload = {
            'sheetId': self.sheet_id,
            'values': [[
                data['date'],
                data['order_no'],
                data['type'],
                data['item'],
                f"{data['quantity']}{data['unit']}",
                data['operator'],
                data['remark']
            ]]
        }
        
        headers = {
            'Content-Type': 'application/json',
            'x-acs-dingtalk-access-token': self.access_token
        }
        
        req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode(),
            headers=headers,
            method='POST'
        )
        
        with urllib.request.urlopen(req) as res:
            return json.loads(res.read())

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    manager = InventoryManager(
        app_key='ä½ çš„AppKey',
        app_secret='ä½ çš„AppSecret',
        sheet_id='ä½ çš„è¡¨æ ¼ID'
    )
    
    # æµ‹è¯•è§£æ
    text = "å…¥åº“ 100ä»¶ iPhone15Pro å•å·RK20240207001 ç»åŠäººå¼ ä¸‰"
    data = manager.parse_inventory_message(text)
    print(f"è§£æç»“æœ: {data}")
```

---

## ğŸ’¬ ä½¿ç”¨æ–¹å¼

**åœ¨é’‰é’‰ç¾¤é‡Œ@æœºå™¨äººå‘é€ï¼š**

```
@è±†èŠ½æœºå™¨äºº å…¥åº“ 100ä»¶ iPhone15Pro å•å·RK20240207001 ç»åŠäººå¼ ä¸‰

@è±†èŠ½æœºå™¨äºº å‡ºåº“ 50å° åä¸ºMate60 å•å·CK20240207002 ç»åŠäººæå›› å®¢æˆ·ï¼šç‹äº”
```

**æœºå™¨äººå›å¤ï¼š**
```
âœ… å…¥åº“è®°å½•å·²å½•å…¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å•å·ï¼šRK20240207001
ç‰©æ–™ï¼šiPhone15Pro
æ•°é‡ï¼š100ä»¶
ç»åŠï¼šå¼ ä¸‰
æ—¶é—´ï¼š2024-02-07 15:30
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å·²åŒæ­¥åˆ°åº“å­˜ç®¡ç†è¡¨
```

---

## ğŸ“Š è¡¨æ ¼æ¨¡æ¿

| æ—¥æœŸ | å•å· | ç±»å‹ | ç‰©æ–™åç§° | æ•°é‡ | ç»åŠäºº | å®¢æˆ· | å¤‡æ³¨ |
|------|------|------|----------|------|--------|------|------|
| 2024-02-07 | RK001 | å…¥åº“ | iPhone15Pro | 100ä»¶ | å¼ ä¸‰ | - | - |
| 2024-02-07 | CK001 | å‡ºåº“ | åä¸ºMate60 | 50å° | æå›› | ç‹äº” | - |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æƒé™é—®é¢˜**ï¼šç¡®ä¿æœºå™¨äººæœ‰è¡¨æ ¼ç¼–è¾‘æƒé™
2. **æ ¼å¼è§„èŒƒ**ï¼šå»ºè®®ç»Ÿä¸€å½•å…¥æ ¼å¼ï¼Œæˆ–è®­ç»ƒAIè¯†åˆ«å„ç§æ ¼å¼
3. **é”™è¯¯å¤„ç†**ï¼šå¢åŠ é‡å¤å•å·æ£€æŸ¥ã€åº“å­˜ä¸è¶³æé†’
4. **æ•°æ®å®‰å…¨**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ï¼Œå®šæœŸå¤‡ä»½

---

## ğŸš€ è¿›é˜¶åŠŸèƒ½

å¯ä»¥æ‰©å±•çš„åŠŸèƒ½ï¼š
- ğŸ“¸ å›¾ç‰‡è¯†åˆ«ï¼ˆæ‹ç…§å…¥åº“å•è‡ªåŠ¨è¯†åˆ«ï¼‰
- ğŸ“Š åº“å­˜é¢„è­¦ï¼ˆä½äºå®‰å…¨åº“å­˜è‡ªåŠ¨æé†’ï¼‰
- ğŸ“ˆ æ•°æ®ç»Ÿè®¡ï¼ˆå‘¨/æœˆæŠ¥è¡¨è‡ªåŠ¨ç”Ÿæˆï¼‰
- ğŸ” åº“å­˜æŸ¥è¯¢ï¼ˆéšæ—¶æŸ¥è¯¢å½“å‰åº“å­˜ï¼‰

éœ€è¦æˆ‘å¸®ä½ å®ç°è¿™ä¸ªæŠ€èƒ½å—ï¼ŸğŸŒ±
